#!/bin/zsh
# Copyright 2015 Han Boetes <han@boetes.org>
# For license info see http://unlicense.org/

# This script generates a very simple database of all my music files.

unset  LC_ALL
export LC_COLLATE=C
export LANG=en_US.UTF-8

config="~/.config/muzshic/config"

if [[ -r ${~config} ]]; then
    source ${~config}
else
    print 'run genconfig to generate a configuration file.' >&2
    exit 0
fi

touch $playlist.new || exit 1

if [[ $1 == -f ]]; then
    database=($(find ${~database}  -maxdepth 1 -mindepth 1 -type d -mmin -60))
    if [[ -n "$database" ]]; then
        database=($(find ${~database}  -maxdepth 1 -mindepth 1 -type d -mmin -60))
    fi
    if [[ -z "$database" ]]; then
        echo "No new files found."
        exit 0
    fi
fi


time find ${~database} \
    -type f \
    -name '*.mp3'  -o \
    -name '*.ogg'  -o \
    -name '*.flac' -o \
    -name '*.ape'  -o \
    -name '*.aac'  -o \
    -name '*.wav'  -o \
    -name '*.m4a' -o \
    -name '*.mkv' -o \
    -name '*.opus' -o \
    -name '*.dff'  -o \
    -name '*.webm' -o \
    -name '*.mpc' | sort -n | gzip -c > $playlist.new

if [[ $1 == -f ]]; then
    zcat $playlist $playlist.new | sort -n | gzip -c > $playlist.newest
    mv $playlist.newest $playlist.new
fi
if [ -e $playlist ]; then
    # If zdiff returns an error, it's because a difference has been found.
    (zdiff -u $playlist $playlist.new || : )| colordiff | less -R || print "Consider installing diff and colordiff" >&2
fi
mv -f ${playlist}.new $playlist
zgrep -E '\.(wav|ape)$' $playlist
